<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flappy Birch - Full (Shop, Profile, FOV, Ranks)</title>
<style>
  :root{--menu-size:60px;}
  html,body{height:100%; margin:0; background:#70c5ce; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; -webkit-text-size-adjust:100%; touch-action:none; overflow:hidden;}
  #gameWrap{position:relative; width:100%; height:100vh; overflow:hidden; display:flex; align-items:center; justify-content:center;}
  canvas{background:linear-gradient(#70c5ce,#4ec0d8); display:block; border:0; box-shadow:0 6px 20px rgba(0,0,0,0.2);}

  /* Floating circular draggable menu button */
  #menuButton{
    position:absolute;
    top:20px; left:20px;
    width:var(--menu-size); height:var(--menu-size);
    border-radius:50%;
    background:rgba(255,255,255,0.95);
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    z-index:80;
    touch-action:none;
    user-select:none;
    cursor:grab;
    border:2px solid rgba(0,0,0,0.12);
    overflow:hidden;
  }
  #menuButton:active{cursor:grabbing;}
  #menuIcon{width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:28px;}

  /* menu content */
  #menuContent{
    position:absolute;
    top:calc(20px + var(--menu-size) + 10px);
    left:20px;
    width:260px;
    background:rgba(255,255,255,0.98);
    border-radius:12px;
    padding:10px;
    box-shadow:0 8px 30px rgba(0,0,0,0.18);
    display:none;
    z-index:79;
    max-height:70vh;
    overflow:auto;
  }
  #menuContent h4{margin:0 0 8px 0; font-size:14px;}
  .row{display:flex; align-items:center; gap:8px; margin:6px 0;}
  label.switch{display:inline-flex; align-items:center; gap:8px; font-size:13px;}
  input[type=range]{width:100%;}
  button.small{padding:6px 8px; border-radius:6px; border:1px solid rgba(0,0,0,0.08); background:#fff; cursor:pointer; font-size:13px;}

  /* tabs inside menu */
  .tabs{display:flex; gap:6px; margin-bottom:8px;}
  .tab{flex:1; text-align:center; padding:6px; border-radius:8px; cursor:pointer; background:rgba(0,0,0,0.04);}
  .tab.active{background:linear-gradient(90deg,#ffd86b,#ffb67a); font-weight:700;}

  /* shop grid */
  .grid{display:flex; gap:8px; flex-wrap:wrap;}
  .card{width:80px; background:#fff; border-radius:8px; padding:6px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.06);}
  .card img{width:64px; height:40px; object-fit:cover; border-radius:6px;}

  /* profile panel */
  #profilePanel{position:absolute; right:12px; top:12px; background:rgba(255,255,255,0.95); padding:10px; border-radius:10px; z-index:70; box-shadow:0 6px 18px rgba(0,0,0,0.12); width:220px; font-size:13px;}

  #message{position:absolute; left:50%; transform:translateX(-50%); top:18%; background:rgba(0,0,0,0.7); color:white; padding:8px 12px; border-radius:6px; display:none; z-index:60; font-weight:600;}

  /* Level-up popup */
  #levelPopup{position:absolute; left:50%; top:40%; transform:translate(-50%,-50%); background:linear-gradient(180deg,#fff7e6,#ffd); padding:16px; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,0.25); display:none; z-index:100; text-align:center; width:280px;}
  #levelPopup .title{font-weight:800; margin-bottom:8px;}
  #levelPopup .gift{font-size:40px; margin-bottom:6px;}

  @media (max-width:420px){ #menuContent{width:210px;} #profilePanel{width:170px;} }
</style>
</head>
<body>
<div id="gameWrap">
  <canvas id="canvas" width="360" height="640" aria-label="Flappy Birch game"></canvas>

  <div id="menuButton" title="Menu">
    <div id="menuIcon" aria-hidden="true">
      <!-- inline troll face SVG (small) -->
      <svg viewBox="0 0 64 64" width="44" height="44" xmlns="http://www.w3.org/2000/svg">
        <g fill="none" stroke="#000" stroke-width="1.6">
          <ellipse cx="32" cy="32" rx="28" ry="24" fill="#fff"/>
          <path d="M12 28c6 0 4-8 20-8s14 8 20 8" stroke-linecap="round"/>
          <circle cx="22" cy="26" r="4" fill="#000"/>
          <circle cx="42" cy="26" r="4" fill="#000"/>
          <path d="M16 42c4-2 8 6 16 6s12-8 16-6c0 0-6 10-24 10S16 42 16 42z" fill="#000"/>
        </g>
      </svg>
    </div>
  </div>

  <div id="menuContent" aria-hidden="true">
    <div class="tabs">
      <div class="tab active" data-tab="menu">Menu</div>
      <div class="tab" data-tab="shop">Shop</div>
      <div class="tab" data-tab="profile">Profile</div>
    </div>

    <!-- Menu Tab -->
    <div id="tab-menu">
      <h4>Game Menu</h4>
      <div class="row"><label class="switch"><input id="fovToggle" type="checkbox"> B·∫≠t FOV</label></div>
      <div class="row"><div style="flex:1"><label style="font-size:12px">FOV b√°n k√≠nh: <span id="fovVal">120</span>px</label><input id="fovSlider" type="range" min="30" max="350" value="120"></div></div>
      <div class="row" style="justify-content:space-between;"><button id="autoBtn" class="small">Auto: Off</button><button id="infBtn" class="small">INF Ti·ªÅn: Off</button></div>
      <div style="font-size:12px; margin-top:8px; color:#333;">
        <div>Ghi ch√∫:</div>
        <ul style="padding-left:18px; margin:6px 0 0 0;">
          <li>FOV v·∫Ω v√≤ng tr√≤n quanh chim v√† d√≤ ·ªëng trong b√°n k√≠nh.</li>
          <li>Auto ch∆°i: b·∫≠t ƒë·ªÉ chim t·ª± n√© ·ªëng (AI c·∫£i ti·∫øn).</li>
        </ul>
      </div>
    </div>

    <!-- Shop Tab -->
    <div id="tab-shop" style="display:none;">
      <h4>C·ª≠a h√†ng</h4>
      <div style="font-size:12px; margin-bottom:8px;">Ch·ªçn Skin Chim (mua b·∫±ng Coins)</div>
      <div class="grid" id="birdShop"></div>
      <div style="height:8px"></div>
      <div style="font-size:12px; margin-bottom:8px;">Ch·ªçn Skin ·ªêng</div>
      <div class="grid" id="pipeShop"></div>
    </div>

    <!-- Profile Tab -->
    <div id="tab-profile" style="display:none;">
      <h4>Th√¥ng tin t√†i kho·∫£n</h4>
      <div style="display:flex; gap:8px; align-items:center;">
        <div style="width:56px; height:56px; border-radius:8px; background:#ffe7a8; display:flex; align-items:center; justify-content:center; font-weight:800;" id="profileAvatar">B</div>
        <div style="flex:1;">
          <div id="profileName">Player</div>
          <div style="font-size:12px; color:#555;">Rank: <span id="profileRank">Bronze</span></div>
        </div>
      </div>
      <div style="margin-top:8px; font-size:13px;">
        Level: <b id="profileLevel">1</b><br>
        Coins: <b id="profileCoins">0</b><br>
        Owned skins: <span id="profileSkins">None</span>
      </div>
      <div style="margin-top:12px;"><button id="claimLevelBtn" class="small">Nh·∫≠n qu√† c·∫•p hi·ªán t·∫°i</button></div>
    </div>
  </div>

  <div id="profilePanel" aria-hidden="false">
    <div style="font-weight:700; font-size:15px;">Player</div>
    <div style="display:flex; gap:8px; margin-top:6px; align-items:center;">
      <div style="width:40px; height:40px; border-radius:6px; background:#ffdd57;" id="miniAvatar"></div>
      <div>
        LV <span id="lvMini">1</span><br>
        <span id="rankMini">Bronze I</span>
      </div>
    </div>
    <div style="margin-top:8px;">Coins: <b id="coinsMini">0</b></div>
  </div>

  <div id="message">·ªêng g·∫ßn k√¨a!</div>

  <div id="levelPopup">
    <div class="title">L√™n c·∫•p!</div>
    <div class="gift">üéÅ</div>
    <div id="levelPopupText">B·∫°n nh·∫≠n ƒë∆∞·ª£c ph·∫ßn th∆∞·ªüng.</div>
    <div style="margin-top:10px;"><button id="closePopup" class="small">OK</button></div>
  </div>
</div>

<script>
// ----------------- Data & initial state -----------------
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;

let bird = { x:80, y:H/2, w:28, h:20, vel:0, gravity:0.6, lift:-10, skin:0 };
let pipes = [];
let frame = 0;
let gap = 140;
let pipeSpeed = 2.4;
let spawnEvery = 90;
let score = 0;
let coins = 0;
let level = 1;
let running = true;
let autoPlay = false;
let infMoney = false;
let fovOn = false;
let fovRadius = 120;

const maxLevel = 100;
const scorePerLevel = 10; // m·ªói 10 score tƒÉng 1 level (kh√¥ng tƒÉng li√™n t·ª•c)
let nextLevelScore = scorePerLevel;

// skins (simple color swatches)
const birdSkins = [
  {id:0, name:'Default', price:0, color:'#ffdd57'},
  {id:1, name:'Red', price:50, color:'#ff6b6b'},
  {id:2, name:'Blue', price:120, color:'#4dabf7'},
  {id:3, name:'Gold', price:500, color:'#ffd700'}
];
const pipeSkins = [
  {id:0, name:'Default', price:0, color:'#2e8b57'},
  {id:1, name:'Stone', price:80, color:'#6b6b6b'},
  {id:2, name:'Pink', price:150, color:'#ff77b5'}
];

// Profile storage (simulate saving to localStorage)
const STORAGE_KEY = 'flappy_birch_profile_v2';
let profile = { name: 'Player', coins:0, ownedBirds:[0], ownedPipes:[0], birdSkin:0, pipeSkin:0, level:1, scoreAll:0 };

function loadProfile(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw){ profile = JSON.parse(raw); }
  }catch(e){ console.warn(e); }
  // sync with runtime
  coins = profile.coins || 0;
  level = profile.level || 1;
  bird.skin = profile.birdSkin || 0;
  updateHUD();
}
function saveProfile(){
  profile.coins = coins;
  profile.level = level;
  profile.birdSkin = bird.skin;
  profile.pipeSkin = currentPipeSkin;
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(profile)); }catch(e){}
}

loadProfile();

// UI elements
const fovToggle = document.getElementById('fovToggle');
const fovSlider = document.getElementById('fovSlider');
const fovVal = document.getElementById('fovVal');
const scoreEl = document.getElementById('coinsMini'); // will update separately
const coinsElTop = document.getElementById('profileCoins');
const profileLevelEl = document.getElementById('profileLevel');
const profileSkinsEl = document.getElementById('profileSkins');
const profileNameEl = document.getElementById('profileName');
const profileRankEl = document.getElementById('profileRank');
const lvMiniEl = document.getElementById('lvMini');
const rankMiniEl = document.getElementById('rankMini');
const coinsMiniEl = document.getElementById('coinsMini');
const coinsEl = document.getElementById('coins');
const scoreDisplay = document.getElementById('score');
const profilePanel = document.getElementById('profilePanel');
const levelPopup = document.getElementById('levelPopup');
const levelPopupText = document.getElementById('levelPopupText');
const messageEl = document.getElementById('message');

// current pipe skin index
let currentPipeSkin = profile.pipeSkin || 0;

// ----------------- Helpers -----------------
function updateHUD(){
  document.getElementById('score').textContent = score;
  document.getElementById('coins').textContent = coins >= Number.MAX_SAFE_INTEGER ? '‚àû' : coins;
  document.getElementById('level').textContent = level;
  document.getElementById('profileCoins').textContent = coins >= Number.MAX_SAFE_INTEGER ? '‚àû' : coins;
  profileLevelEl.textContent = level;
  profileNameEl.textContent = profile.name || 'Player';
  profileSkinsEl.textContent = 'Bird:' + (profile.birdSkin||0) + ' Pipe:' + (profile.pipeSkin||0);
  document.getElementById('lvMini').textContent = level;
  document.getElementById('coinsMini').textContent = coins >= Number.MAX_SAFE_INTEGER ? '‚àû' : coins;
  const r = rankForLevel(level);
  document.getElementById('profileRank').textContent = r.name;
  document.getElementById('rankMini').textContent = r.name + (r.stars?(' ' + '‚òÖ'.repeat(r.stars)) : '');
}
function rankForLevel(lv){
  // simple tiers mapping
  const tiers = [
    {name:'Bronze', max:10},
    {name:'Silver', max:20},
    {name:'Gold', max:30},
    {name:'Platinum', max:40},
    {name:'Diamond', max:60},
    {name:'Heroic', max:80},
    {name:'Grandmaster', max:100}
  ];
  let acc = 0;
  for (let t of tiers){
    if (lv <= t.max) {
      // stars proportional inside tier (1..3)
      const prev = acc+1;
      const range = t.max - acc;
      let pos = Math.min(range, lv - prev + 1);
      let stars = Math.min(3, Math.floor((pos / range) * 3) || 1);
      return {name:t.name, stars:stars};
    }
    acc = t.max;
  }
  return {name:'Legend', stars:3};
}

// ----------------- Game core -----------------
canvas.addEventListener('pointerdown', (e)=>{ e.preventDefault(); flap(); }, {passive:false});
function flap(){ bird.vel = bird.lift; }

function spawnPipe(){
  const top = Math.random() * (H - gap - 140) + 40;
  pipes.push({ x: W + 20, top: top, width: 56, passed:false });
}

function collides(pipe){
  if (bird.x + bird.w > pipe.x && bird.x < pipe.x + pipe.width){
    if (bird.y < pipe.top || bird.y + bird.h > pipe.top + gap) return true;
  }
  return false;
}

function improveAutoAI(){
  // better prediction: determine vertical target using next pipe gap center
  let next = null;
  for (let p of pipes){
    if (p.x + p.width > bird.x - 10){ next = p; break; }
  }
  if (!next) return false;
  const targetY = next.top + gap/2;
  const distX = next.x - bird.x;
  // If close and low, flap; if above gap, don't flap
  if (distX < 180){
    // compute simple required upward movement
    if (bird.y > targetY - 8) return true;
  }
  return false;
}

function update(){
  frame++;
  if (frame % spawnEvery === 0) spawnPipe();

  bird.vel += bird.gravity;
  bird.y += bird.vel;
  if (bird.y + bird.h > H - 80){ bird.y = H - 80 - bird.h; bird.vel = 0; resetGame(); }
  if (bird.y < 0){ bird.y = 0; bird.vel = 0; }

  for (let i = pipes.length-1; i>=0; i--){
    let p = pipes[i];
    p.x -= pipeSpeed;
    if (!p.passed && p.x + p.width < bird.x){
      p.passed = true;
      score++; profile.scoreAll = (profile.scoreAll||0)+1;
      // coin reward
      coins += 1;
      // level up check every scorePerLevel points
      if (score >= nextLevelScore && level < maxLevel){
        level++; nextLevelScore += scorePerLevel; onLevelUp(level);
      }
      saveProfile();
      updateHUD();
    }
    if (p.x + p.width < -40) pipes.splice(i,1);
    if (collides(p)) { resetGame(); }
  }

  // improved Auto Play
  if (autoPlay){
    if (improveAutoAI()) flap();
  }

  if (infMoney){
    coins = Number.MAX_SAFE_INTEGER; // show infinity
  }

  // FOV detection circle around bird
  let nearFound = false;
  if (fovOn){
    for (let p of pipes){
      let bx = bird.x + bird.w/2, by = bird.y + bird.h/2;
      let rx1 = p.x, rx2 = p.x + p.width;
      let ry1_top = 0, ry2_top = p.top;
      let ry1_bot = p.top + gap, ry2_bot = H;
      function circleRectIntersect(cx,cy,r,rx1,ry1,rx2,ry2){
        let closestX = Math.max(rx1, Math.min(cx, rx2));
        let closestY = Math.max(ry1, Math.min(cy, ry2));
        let dx = closestX - cx, dy = closestY - cy;
        return (dx*dx + dy*dy) <= r*r;
      }
      if (circleRectIntersect(bx,by,fovRadius, rx1,ry1_top, rx2,ry2_top) ||
          circleRectIntersect(bx,by,fovRadius, rx1,ry1_bot, rx2,ry2_bot)){
        nearFound = true; p._inFov = true;
      } else p._inFov = false;
    }
  } else {
    for (let p of pipes) p._inFov = false;
  }

  if (nearFound) showMessage("·ªêng g·∫ßn k√¨a!"); else hideMessage();

  render();
  requestAnimationFrame(update);
}

function render(){
  ctx.clearRect(0,0,W,H);
  // ground
  ctx.fillStyle = "#ded895";
  ctx.fillRect(0, H - 80, W, 80);

  // pipes
  for (let p of pipes){
    ctx.fillStyle = p._inFov ? "rgba(255,80,80,0.95)" : (pipeSkins[currentPipeSkin].color || '#2e8b57');
    ctx.fillRect(p.x, 0, p.width, p.top);
    ctx.fillStyle = p._inFov ? "rgba(200,60,60,0.95)" : darken(pipeSkins[currentPipeSkin].color || '#246b45', 0.2);
    ctx.fillRect(p.x - 4, p.top - 12, p.width + 8, 12);
    ctx.fillRect(p.x, p.top + gap, p.width, H - (p.top + gap) - 80);
    ctx.fillRect(p.x - 4, p.top + gap, p.width + 8, 12);
  }

  // bird (skin)
  ctx.fillStyle = birdSkins[bird.skin].color || '#ffdd57';
  ctx.fillRect(bird.x, bird.y, bird.w, bird.h);
  ctx.fillStyle = "#000";
  ctx.fillRect(bird.x + bird.w - 8, bird.y + 6, 4, 4);

  // FOV circle
  if (fovOn){
    ctx.beginPath();
    ctx.arc(bird.x + bird.w/2, bird.y + bird.h/2, fovRadius, 0, Math.PI*2);
    ctx.strokeStyle = "rgba(255,255,255,0.9)"; ctx.lineWidth = 2; ctx.setLineDash([6,6]); ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle = "rgba(0,200,80,0.06)"; ctx.beginPath(); ctx.arc(bird.x + bird.w/2, bird.y + bird.h/2, fovRadius, 0, Math.PI*2); ctx.fill();
  }

  // score text
  ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.font = "18px Arial"; ctx.fillText("Score: " + score, 12, 28);
  ctx.fillText("Coins: " + (coins >= Number.MAX_SAFE_INTEGER ? '‚àû' : coins), 12, 50);
}

function resetGame(){
  bird.y = H/2; bird.vel = 0;
  pipes = []; frame = 0; score = 0;
  nextLevelScore = scorePerLevel;
  if (!infMoney){ coins = profile.coins || 0; }
  updateHUD();
}

// ----------------- UI: menu drag & toggle, prevent scroll -----------------
const menuButton = document.getElementById('menuButton');
const menuContent = document.getElementById('menuContent');
let dragging = false, dx=0, dy=0, startX=0, startY=0, startLeft=0, startTop=0, movedDuringPointer=false;

menuButton.addEventListener('pointerdown', (ev)=>{
  ev.preventDefault();
  dragging = true; movedDuringPointer=false;
  startX = ev.clientX; startY = ev.clientY;
  const rect = menuButton.getBoundingClientRect();
  startLeft = rect.left; startTop = rect.top;
  menuButton.setPointerCapture(ev.pointerId);
});
document.addEventListener('pointermove', (ev)=>{
  if (!dragging) return;
  let nx = startLeft + (ev.clientX - startX);
  let ny = startTop + (ev.clientY - startY);
  // clamp inside viewport
  nx = Math.max(6, Math.min(window.innerWidth - rectSize() - 6, nx));
  ny = Math.max(6, Math.min(window.innerHeight - rectSize() - 6, ny));
  menuButton.style.left = nx + 'px';
  menuButton.style.top = ny + 'px';
  movedDuringPointer = true;
});
document.addEventListener('pointerup', (ev)=>{
  if (!dragging) return;
  dragging = false; try{ menuButton.releasePointerCapture(ev.pointerId);}catch(e){}
  if (!movedDuringPointer) toggleMenu();
});
function rectSize(){ return parseInt(getComputedStyle(menuButton).width); }
function toggleMenu(){
  if (menuContent.style.display === 'block'){ menuContent.style.display='none'; menuContent.setAttribute('aria-hidden','true'); }
  else {
    const r = menuButton.getBoundingClientRect();
    menuContent.style.left = Math.max(6, Math.min(window.innerWidth - 20 - 260, r.left)) + 'px';
    menuContent.style.top = (r.top + rectSize() + 10) + 'px';
    menuContent.style.display = 'block'; menuContent.setAttribute('aria-hidden','false');
    // show menu default tab
    activateTab('menu');
  }
}
// prevent page scrolling and pinch gestures interfering
document.addEventListener('touchmove', function(e){ e.preventDefault(); }, {passive:false});

// menu tabs
document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=> activateTab(t.dataset.tab)));
function activateTab(name){
  document.querySelectorAll('.tab').forEach(x=> x.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  document.getElementById('tab-menu').style.display = name==='menu'?'block':'none';
  document.getElementById('tab-shop').style.display = name==='shop'?'block':'none';
  document.getElementById('tab-profile').style.display = name==='profile'?'block':'none';
  if (name==='shop') renderShop();
  if (name==='profile') renderProfile();
}

// FOV controls
fovToggle.addEventListener('change', (e)=>{ fovOn = e.target.checked; });
fovSlider.addEventListener('input', (e)=>{ fovRadius = Number(e.target.value); fovVal.textContent = fovRadius; });

// Buttons
const autoBtn = document.getElementById('autoBtn');
autoBtn.addEventListener('click', ()=>{ autoPlay = !autoPlay; autoBtn.textContent = 'Auto: ' + (autoPlay ? 'On' : 'Off'); });

const infBtn = document.getElementById('infBtn');
infBtn.addEventListener('click', ()=>{
  infMoney = !infMoney; infBtn.textContent = 'INF Ti·ªÅn: ' + (infMoney ? 'On' : 'Off');
  if (infMoney){ coins = Number.MAX_SAFE_INTEGER; }
  else { coins = profile.coins || 0; }
  updateHUD();
});

document.getElementById('claimLevelBtn').addEventListener('click', ()=>{
  claimLevelReward();
});

document.getElementById('closePopup').addEventListener('click', ()=>{ levelPopup.style.display='none'; });

// ----------------- Shop rendering & logic -----------------
function renderShop(){
  const birdShop = document.getElementById('birdShop');
  birdShop.innerHTML = '';
  for (let s of birdSkins){
    const own = profile.ownedBirds.includes(s.id);
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('div'); img.style.width='64px'; img.style.height='40px'; img.style.background=s.color; img.style.borderRadius='6px';
    card.appendChild(img);
    const title = document.createElement('div'); title.textContent = s.name; title.style.fontSize='12px'; title.style.marginTop='6px';
    card.appendChild(title);
    const btn = document.createElement('button'); btn.className='small'; btn.style.marginTop='6px';
    btn.textContent = own ? (profile.birdSkin===s.id ? 'Equipped' : 'Equip') : ('Buy ' + s.price);
    btn.addEventListener('click', ()=>{
      if (own){
        profile.birdSkin = s.id; bird.skin = s.id; saveProfile(); updateHUD(); renderShop();
      } else {
        if (coins >= s.price){
          coins -= s.price; profile.ownedBirds.push(s.id); profile.birdSkin = s.id; bird.skin = s.id; saveProfile(); updateHUD(); renderShop();
          showMessage('Mua th√†nh c√¥ng ' + s.name);
        } else showMessage('Kh√¥ng ƒë·ªß Coins');
      }
    });
    card.appendChild(btn);
    birdShop.appendChild(card);
  }

  const pipeShop = document.getElementById('pipeShop');
  pipeShop.innerHTML = '';
  for (let s of pipeSkins){
    const own = profile.ownedPipes.includes(s.id);
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('div'); img.style.width='64px'; img.style.height='40px'; img.style.background=s.color; img.style.borderRadius='6px';
    card.appendChild(img);
    const title = document.createElement('div'); title.textContent = s.name; title.style.fontSize='12px'; title.style.marginTop='6px';
    card.appendChild(title);
    const btn = document.createElement('button'); btn.className='small'; btn.style.marginTop='6px';
    btn.textContent = own ? (profile.pipeSkin===s.id ? 'Equipped' : 'Equip') : ('Buy ' + s.price);
    btn.addEventListener('click', ()=>{
      if (own){
        profile.pipeSkin = s.id; currentPipeSkin = s.id; saveProfile(); updateHUD(); renderShop();
      } else {
        if (coins >= s.price){
          coins -= s.price; profile.ownedPipes.push(s.id); profile.pipeSkin = s.id; currentPipeSkin = s.id; saveProfile(); updateHUD(); renderShop();
          showMessage('Mua th√†nh c√¥ng ' + s.name);
        } else showMessage('Kh√¥ng ƒë·ªß Coins');
      }
    });
    card.appendChild(btn);
    pipeShop.appendChild(card);
  }
}

// ----------------- Level up & rewards -----------------
function onLevelUp(newLevel){
  // cap
  if (newLevel > maxLevel){ newLevel = maxLevel; level = maxLevel; }
  // grant reward: coins proportional
  const reward = 10 + Math.floor(newLevel * 2);
  profile.coins = (profile.coins || 0) + reward;
  coins = profile.coins;
  // popup
  levelPopupText.textContent = "Lv " + newLevel + " ‚Äî b·∫°n nh·∫≠n " + reward + " coins!";
  levelPopup.style.display = 'block';
  updateHUD();
  saveProfile();
}

function claimLevelReward(){
  // simple: give small bonus once per level call (here we just show message)
  showMessage('Qu√† ƒë√£ g·ª≠i v√†o t√†i kho·∫£n');
}

// ----------------- Utilities -----------------
function showMessage(txt){
  messageEl.textContent = txt; messageEl.style.display='block';
  if (messageEl._t) clearTimeout(messageEl._t);
  messageEl._t = setTimeout(()=>{ messageEl.style.display='none'; messageEl._t=null; }, 1200);
}
function hideMessage(){ if (!messageEl._t) messageEl.style.display='none'; }

function darken(hex, amt){
  try{
    hex = hex.replace('#','');
    let num = parseInt(hex,16);
    let r = (num>>16) - Math.round(255*amt);
    let g = ((num>>8)&0xff) - Math.round(255*amt);
    let b = (num&0xff) - Math.round(255*amt);
    r = Math.max(0,Math.min(255,r)); g = Math.max(0,Math.min(255,g)); b = Math.max(0,Math.min(255,b));
    return 'rgb('+r+','+g+','+b+')';
  }catch(e){ return hex; }
}

// ----------------- init -----------------
spawnPipe(); spawnPipe();
updateHUD();
renderShop();
requestAnimationFrame(update);

</script>
</body>
</html>
