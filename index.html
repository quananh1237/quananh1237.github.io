<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casio fx-580VN X ‚Äî Full Emulator (near-100%)</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>üßÆ</text></svg>">
<style>
  /* Basic reset */
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; -webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0;background:#0b1420;color:#e6f0fa}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
  /* calc frame */
  .calc-frame{width:980px;max-width:96vw;border-radius:18px;padding:18px;background:
    linear-gradient(180deg,#233240,#07121a);box-shadow:0 20px 60px rgba(0,0,0,.7);display:grid;grid-template-columns:380px 1fr;gap:18px}
  /* left: physical calculator */
  .device{background:linear-gradient(180deg,#0c1b27,#071218);border-radius:12px;padding:18px;display:flex;flex-direction:column;gap:12px;border:4px solid #071520}
  .brand{display:flex;justify-content:space-between;align-items:center;color:#94b3c8}
  .brand .title{font-weight:700}
  .screen-shell{background:linear-gradient(180deg,#082028,#031018);border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,.03)}
  .screen{background:linear-gradient(180deg,#041826,#021018);height:130px;border-radius:6px;padding:8px;color:#cbe8ff;border:1px solid rgba(255,255,255,.02);display:flex;flex-direction:column;justify-content:space-between}
  .statusline{display:flex;justify-content:space-between;color:#7fb1d9;font-size:12px}
  .display-main{font-family: "Courier New", monospace;font-size:20px;line-height:1.05;color:#eaffff;display:flex;flex-direction:column;gap:6px}
  .display-expr{color:#9ec7ff;font-size:15px;min-height:22px;word-break:break-all}
  .display-res{font-size:24px;font-weight:700;min-height:28px}
  .keys{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:6px}
  .key{background:linear-gradient(180deg,#0b2a36,#031219);border-radius:6px;padding:10px;text-align:center;cursor:pointer;user-select:none;border:1px solid rgba(255,255,255,.03)}
  .key.phys{background:linear-gradient(180deg,#0c2f3a,#062128);color:#d6eefc}
  .key.gray{background:linear-gradient(180deg,#22282b,#0f1719);color:#9fb3bf}
  .key.yellow{background:linear-gradient(180deg,#b98f2b,#8b651a);color:#071018;font-weight:700}
  .key.red{background:linear-gradient(180deg,#8b2b63,#51183a);color:#fff;font-weight:700}
  .big{grid-column:span 2}
  .wide3{grid-column:span 3}
  .footer-keys{display:flex;gap:8px;margin-top:8px}
  .small-btn{padding:6px 8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,.03);color:#9fb3bf;cursor:pointer}
  /* right: tools / editors */
  .tools{display:flex;flex-direction:column;gap:12px}
  .panel{background:linear-gradient(180deg,#071b25,#021016);border-radius:8px;padding:12px;min-height:120px;border:1px solid rgba(255,255,255,.02)}
  .panel h3{margin:0 0 8px 0;color:#bfe6ff}
  .row{display:flex;gap:8px}
  input, select, textarea{background:#062129;border:1px solid #0d2f3a;color:#dff3ff;padding:8px;border-radius:6px;width:100%}
  .muted{color:#7aa7c8;font-size:13px}
  .history{max-height:220px;overflow:auto;padding:8px;border-radius:6px;background:linear-gradient(180deg,#031016,#021218)}
  code{background:#021219;padding:6px;border-radius:6px;color:#dff3ff;display:block}
  .hint{color:#8cc7ff;font-size:13px}
  /* responsive */
  @media(max-width:920px){ .calc-frame{grid-template-columns:1fr;max-width:680px} .device{order:2} }
</style>
</head>
<body>
<div class="wrap">
  <div class="calc-frame" role="application" aria-label="Casio fx-580VN X Emulator">
    <!-- Left: Device -->
    <div class="device" id="device">
      <div class="brand">
        <div class="title">Casio <span style="font-weight:900">fx-580VN X</span> ‚Äî Emulator</div>
        <div class="muted">Model: Emu</div>
      </div>

      <div class="screen-shell" aria-hidden="false">
        <div class="screen" id="screen">
          <div class="statusline">
            <div id="status-left">MODE: COMP</div>
            <div id="status-right">SHIFT: OFF ‚Ä¢ ALPHA: OFF</div>
          </div>
          <div class="display-main">
            <div class="display-expr" id="displayExpr">0</div>
            <div class="display-res" id="displayRes">0</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted" id="angle">DEG</div>
            <div class="muted">M: <span id="memCount">0</span> ‚Ä¢ Ans: <span id="ansVal">0</span></div>
          </div>
        </div>
      </div>

      <!-- keys (layout modeled after Casio, condensed) -->
      <div class="keys" id="keys">
        <!-- Row 1 -->
        <div class="key yellow phys" data-key="SHIFT">SHIFT</div>
        <div class="key red phys" data-key="ALPHA">ALPHA</div>
        <div class="key gray phys" data-key="MODE">MODE</div>
        <div class="key gray phys" data-key="SETUP">SETUP</div>
        <div class="key gray phys" data-key="AC">AC</div>
        <div class="key gray phys" data-key="DEL">DEL</div>
        <div class="key gray phys" data-key="(">(</div>
        <div class="key gray phys" data-key=")">)</div>
        <div class="key gray phys" data-key="ANS">Ans</div>
        <div class="key gray phys" data-key="EXP">EXP</div>

        <!-- Row 2 -->
        <div class="key phys" data-key="7">7</div>
        <div class="key phys" data-key="8">8</div>
        <div class="key phys" data-key="9">9</div>
        <div class="key phys" data-key="DEL2" title="Backspace">‚å´</div>
        <div class="key phys" data-key="^">^</div>
        <div class="key phys" data-key="=" data-op="compute">=</div>
        <div class="key phys" data-key="sin">sin</div>
        <div class="key phys" data-key="cos">cos</div>
        <div class="key phys" data-key="tan">tan</div>
        <div class="key phys" data-key="œÄ">œÄ</div>

        <!-- Row 3 -->
        <div class="key phys" data-key="4">4</div>
        <div class="key phys" data-key="5">5</div>
        <div class="key phys" data-key="6">6</div>
        <div class="key phys" data-key="√ó">*</div>
        <div class="key phys" data-key="sqrt">‚àö</div>
        <div class="key phys" data-key="^2">x¬≤</div>
        <div class="key phys" data-key="asin">sin‚Åª¬π</div>
        <div class="key phys" data-key="acos">cos‚Åª¬π</div>
        <div class="key phys" data-key="atan">tan‚Åª¬π</div>
        <div class="key phys" data-key="i">i</div>

        <!-- Row 4 -->
        <div class="key phys" data-key="1">1</div>
        <div class="key phys" data-key="2">2</div>
        <div class="key phys" data-key="3">3</div>
        <div class="key phys" data-key="-">‚àí</div>
        <div class="key phys" data-key="log">log</div>
        <div class="key phys" data-key="ln">ln</div>
        <div class="key phys" data-key="e^x">e^x</div>
        <div class="key phys" data-key="x!">x!</div>
        <div class="key phys" data-key="nPr">nPr</div>
        <div class="key phys" data-key="nCr">nCr</div>

        <!-- Row 5 -->
        <div class="key phys" data-key="0">0</div>
        <div class="key phys" data-key=".">.</div>
        <div class="key phys" data-key="+">+</div>
        <div class="key phys" data-key="ANS2">ANS</div>
        <div class="key phys" data-key="%">%</div>
        <div class="key phys" data-key="1/x">1/x</div>
        <div class="key phys" data-key="RND">Ran</div>
        <div class="key phys" data-key="rec">rec</div>
        <div class="key phys" data-key="BASE">BASE</div>
        <div class="key phys" data-key="M+">M+</div>

        <!-- Row 6 (big keys) -->
        <div class="key wide3 phys" data-key="M-">M-</div>
        <div class="key phys" data-key="MR">MR</div>
        <div class="key phys" data-key="ACLEAR">MC</div>
        <div class="key phys" data-key="MAT">MATRIX</div>
        <div class="key phys" data-key="STAT">STAT</div>
        <div class="key phys" data-key="SOLVE">SOLVE</div>
        <div class="key phys" data-key="SHIFT_LABEL" title="shows shifted functions">(shift)</div>
        <div class="key phys" data-key="ALPHA_LABEL" title="shows alpha letters">(alpha)</div>
      </div>

      <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:8px">
        <div class="muted">Built for Web ‚Äî math.js</div>
        <div style="display:flex;gap:8px">
          <button class="small-btn" id="exportBtn">Export</button>
          <button class="small-btn" id="importBtn">Import</button>
        </div>
      </div>
    </div>

    <!-- Right: Tools & Editors -->
    <div class="tools">
      <div class="panel">
        <h3>Quick Controls</h3>
        <div class="row" style="margin-bottom:8px">
          <select id="modeSelect">
            <option value="COMP">COMP</option>
            <option value="STAT">STAT</option>
            <option value="MATRIX">MATRIX</option>
            <option value="EQUA">EQUA</option>
            <option value="BASE">BASE</option>
            <option value="COMPLEX">COMPLEX</option>
          </select>
          <button class="small-btn" id="openHistory">History</button>
          <button class="small-btn" id="clearHistory">Clear</button>
        </div>
        <div class="muted">Tips: SHIFT + key -> access upper (yellow) functions. ALPHA + key -> letters/variables.</div>
      </div>

      <div class="panel">
        <h3>History</h3>
        <div class="history" id="historyBox"></div>
      </div>

      <div class="panel">
        <h3>Advanced Tools</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="small-btn" id="openMatrix">Matrix Editor</button>
          <button class="small-btn" id="openStat">STAT Editor</button>
          <button class="small-btn" id="openEq">Equation Solver</button>
          <button class="small-btn" id="openBase">Base Converter</button>
        </div>
        <div class="muted">Alpha input supports A..Z variables for custom labeling. Memory registers: M (single) and variables A..F saved in storage (simulate).</div>
      </div>
    </div>
  </div>
</div>

<!-- modal root -->
<div id="modalRoot" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999"></div>

<!-- math.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.0/lib/browser/math.js"></script>

<script>
/* Full-featured Casio-like emulator (best-effort)
   - SHIFT/ALPHA state
   - keymap with upper (yellow) functions shown by SHIFT
   - many functions implemented using math.js
   - matrix, stat, equation, base converter editors in modals
   - history, memory (M plus variables A-F simulation)
   - sexagesimal conversion, nCr/nPr, factorial, permutations/combinations
   - Not every Casio "tiny" submenu is implemented but SHIFT combos exist as UI for hidden functions
*/

/* STATE */
const S = {
  expr: '0',
  ans: 0,
  mem: 0,
  vars: {A:null,B:null,C:null,D:null,E:null,F:null},
  shift: false,
  alpha: false,
  mode: 'COMP', // COMP, STAT, MATRIX, EQUA, BASE, COMPLEX
  angle: 'DEG', // DEG RAD GRAD
  history: []
};

/* UI hooks */
const displayExpr = document.getElementById('displayExpr');
const displayRes = document.getElementById('displayRes');
const statusLeft = document.getElementById('status-left');
const statusRight = document.getElementById('status-right');
const angleEl = document.getElementById('angle');
const ansVal = document.getElementById('ansVal');
const memCount = document.getElementById('memCount');
const historyBox = document.getElementById('historyBox');
const modalRoot = document.getElementById('modalRoot');

function render(){
  displayExpr.textContent = S.expr;
  displayRes.textContent = format(S.ans);
  statusLeft.textContent = 'MODE: ' + S.mode;
  statusRight.textContent = `SHIFT: ${S.shift ? 'ON' : 'OFF'} ‚Ä¢ ALPHA: ${S.alpha ? 'ON' : 'OFF'}`;
  angleEl.textContent = S.angle;
  ansVal.textContent = format(S.ans);
  memCount.textContent = format(S.mem);
  renderHistory();
}
function format(v){
  try{
    if(v===null||v===undefined) return '0';
    if(typeof v === 'number' && !isFinite(v)) return String(v);
    if(math.typeOf && math.typeOf(v)==='Complex') return v.toString();
    return math.format(v, {precision: 14});
  }catch(e){ return String(v); }
}
function renderHistory(){
  historyBox.innerHTML = '';
  S.history.slice(0,50).forEach(h=>{
    const d = document.createElement('div');
    d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='4px 0';
    d.innerHTML = `<div style="color:#9ed3ff">${h.expr}</div><div style="color:#e8f7ff">${format(h.res)}</div>`;
    historyBox.appendChild(d);
  });
}

/* utility: sanitize expression to math.js */
function sanitize(expr){
  let s = expr;
  s = s.replace(/√∑/g,'/').replace(/√ó/g,'*').replace(/‚àí/g,'-');
  // factorial: replace n! with factorial(n)
  s = s.replace(/([0-9\.]+)!/g,'factorial($1)');
  // percent n% -> (n/100)
  s = s.replace(/([0-9\.]+)%/g,'($1/100)');
  // œÄ
  s = s.replace(/œÄ/g, String(Math.PI));
  // caret ^ is fine
  // i for complex unit
  return s;
}

/* evaluate expression */
function evaluateExpr(expr){
  try{
    const s = sanitize(expr);
    // allow using Ans keyword
    const replaced = s.replace(/Ans/g, String(S.ans));
    const res = math.evaluate(replaced);
    S.ans = res;
    S.history.unshift({expr: expr, res: res, time: Date.now()});
    return res;
  }catch(e){
    return 'Error';
  }
}

/* key handling */
document.getElementById('keys').addEventListener('click', e=>{
  const key = e.target.closest('.key');
  if(!key) return;
  const k = key.dataset.key;
  if(!k) return;
  handleKey(k);
});

function handleKey(k){
  // SHIFT/ALPHA toggles
  if(k==='SHIFT'){ S.shift = !S.shift; S.alpha = false; render(); return; }
  if(k==='ALPHA'){ S.alpha = !S.alpha; S.shift = false; render(); return; }

  // MODE and SETUP
  if(k==='MODE'){ openModePicker(); return; }
  if(k==='SETUP'){ alert('Setup dialog - emulate: Angle/Display/Fix'); return; }

  // AC (clear), DEL
  if(k==='AC'){ S.expr='0'; render(); return; }
  if(k==='DEL' || k==='DEL2'){ if(S.expr.length<=1) S.expr='0'; else S.expr = S.expr.slice(0,-1); render(); return; }

  // compute
  if(k==='=' || keyIsCompute(k)) { compute(); return; }

  // SHIFT combos: emulate many hidden functions
  if(S.shift){
    handleShiftPlus(k);
    S.shift = false; render();
    return;
  }
  if(S.alpha){
    handleAlphaPlus(k);
    S.alpha = false; render();
    return;
  }

  // direct insert or operation
  switch(k){
    case 'œÄ': appendRaw('œÄ'); break;
    case '^': appendRaw('^'); break;
    case '√ó': appendRaw('*'); break;
    case 'ANS': appendRaw(String(S.ans)); break;
    case 'ANS2': appendRaw('Ans'); break;
    case 'EXP': appendRaw('e'); break;
    case 'RND': appendRaw('random()'); break;
    case 'nPr': appendRaw('nPr('); break;
    case 'nCr': appendRaw('nCr('); break;
    case 'x!': appendRaw('!'); break;
    case 'sqrt': appendRaw('sqrt('); break;
    case 'log': appendRaw('log10('); break;
    case 'ln': appendRaw('log('); break;
    case 'e^x': appendRaw('exp('); break;
    case '%': appendRaw('%'); break;
    case '1/x': appendRaw('(1/('); break;
    case 'rec': appendRaw('reciprocal('); break;
    case 'BASE': openBase(); break;
    case 'MAT': openMatrix(); break;
    case 'STAT': openStat(); break;
    case 'SOLVE': openEq(); break;
    case 'M+': S.mem = Number(S.mem) + Number(S.ans); break;
    case 'M-': S.mem = Number(S.mem) - Number(S.ans); break;
    case 'MR': appendRaw(String(S.mem)); break;
    case 'ACLEAR': S.mem=0; break;
    default:
      if(/^[0-9]$/.test(k)) appendRaw(k);
      else if(k==='.'){ appendRaw('.'); }
      else if(['+','-','*','/','^'].includes(k)) appendRaw(k);
      else if(['sin','cos','tan','asin','acos','atan'].includes(k)) appendRaw(k + '(');
      else appendRaw(k);
  }
  render();
}

function appendRaw(t){
  if(S.expr==='0') S.expr = t; else S.expr += t;
}

/* compute behavior */
function compute(){
  const out = evaluateExpr(S.expr);
  S.expr = String(out);
  render();
}

/* SHIFT combos for hidden functions ‚Äî best-effort mapping */
function handleShiftPlus(k){
  // Example: SHIFT + x! -> gamma? SHIFT + nCr -> Combinatorial with alternate display
  switch(k){
    case 'sin': appendRaw('sinh('); break;
    case 'cos': appendRaw('cosh('); break;
    case 'tan': appendRaw('tanh('); break;
    case 'ln': appendRaw('log10('); break;
    case 'log': appendRaw('log('); break;
    case 'œÄ': appendRaw(String(Math.PI*2)); break; // SHIFT+œÄ -> œÑ
    case 'x!': appendRaw('gamma('); break; // factorial alternative
    case 'nPr': appendRaw('perm('); break;
    case 'nCr': appendRaw('comb('); break;
    case 'sqrt': appendRaw('cbrt('); break;
    case 'M+': // SHIFT+M+ -> store to next var
      storeToNextVar(S.ans);
      break;
    case 'MR':
      // SHIFT+MR: show variables
      alert('Variables: ' + JSON.stringify(S.vars));
      break;
    default:
      appendRaw(k);
  }
}

/* ALPHA combos ‚Äî simulate entering letters A..Z by pressing ALPHA + key */
function handleAlphaPlus(k){
  // simple mapping: number keys map to letters as typical calculators (like 2: ABC, 3: DEF)
  const mapping = {
    '1':'1', '2':'ABC', '3':'DEF', '4':'GHI', '5':'JKL', '6':'MNO',
    '7':'PQRS', '8':'TUV', '9':'WXYZ', '0':' '
  };
  if(mapping[k]){
    // choose first letter for simplicity
    const letter = mapping[k][0];
    appendRaw(letter);
  }else{
    // for keys with labels, just use the key's first char
    appendRaw(String(k)[0] || '');
  }
}

/* helper: store ans into next empty variable A..F */
function storeToNextVar(val){
  const keys = ['A','B','C','D','E','F'];
  for(let k of keys){
    if(S.vars[k]===null){ S.vars[k] = val; alert('Stored Ans to var ' + k); return; }
  }
  // if full, overwrite A
  S.vars['A'] = val; alert('Vars full. Overwriting A.');
}

/* modal and editors */
function openModePicker(){
  const sel = prompt('Mode (COMP/STAT/MATRIX/EQUA/BASE/COMPLEX)', S.mode);
  if(sel) { S.mode = sel.toUpperCase(); render(); }
}
document.getElementById('modeSelect').addEventListener('change', e=>{ S.mode = e.target.value; render(); });

/* matrix editor */
function openMatrix(){
  modalRoot.innerHTML = '';
  const box = document.createElement('div');
  box.style.background='#021219'; box.style.padding='12px'; box.style.border='1px solid #094'; box.style.borderRadius='8px';
  box.innerHTML = `<h3 style="margin:0;color:#8df">Matrix Editor</h3>
    <div style="margin-top:8px"><label class="muted">Rows:</label> <select id="mRows"><option>2</option><option selected>3</option><option>4</option></select>
    <label class="muted">Cols:</label> <select id="mCols"><option>2</option><option selected>3</option><option>4</option></select>
    <button id="mCreate" class="small-btn">Create</button> <button id="mClose" class="small-btn">Close</button></div>
    <div id="mGrid" style="margin-top:8px"></div>
    <div style="margin-top:8px"><button id="mInsert" class="small-btn">Insert into Expr</button>
    <button id="mDet" class="small-btn">Determinant</button>
    <button id="mInv" class="small-btn">Inverse</button></div>
    <div id="mOut" style="margin-top:8px;color:#9bf"></div>`;
  modalRoot.appendChild(box);

  function build(){
    const r = Number(box.querySelector('#mRows').value);
    const c = Number(box.querySelector('#mCols').value);
    const grid = box.querySelector('#mGrid'); grid.innerHTML='';
    const table = document.createElement('div'); table.style.display='grid'; table.style.gridTemplateColumns = `repeat(${c},1fr)`; table.style.gap='6px';
    for(let i=0;i<r;i++){
      for(let j=0;j<c;j++){
        const inp = document.createElement('input'); inp.value='0'; inp.style.background='#041018'; inp.style.border='1px solid #083'; inp.style.color='#dff';
        inp.dataset.r=i; inp.dataset.c=j; inp.style.padding='6px'; table.appendChild(inp);
      }
    }
    grid.appendChild(table);
  }
  box.querySelector('#mCreate').addEventListener('click', build);
  box.querySelector('#mClose').addEventListener('click', ()=> modalRoot.innerHTML='');
  box.querySelector('#mInsert').addEventListener('click', ()=>{
    const grid = box.querySelectorAll('#mGrid input');
    if(!grid.length) return alert('Create matrix first');
    const rows = Math.max(...Array.from(grid).map(i=>Number(i.dataset.r)))+1;
    const cols = Math.max(...Array.from(grid).map(i=>Number(i.dataset.c)))+1;
    const arr = [];
    for(let i=0;i<rows;i++){
      const row=[];
      for(let j=0;j<cols;j++){
        const v = box.querySelector(`input[data-r="${i}"][data-c="${j}"]`).value || '0';
        row.push(v);
      }
      arr.push('['+row.join(',')+']');
    }
    appendRaw('matrix(' + arr.join(',') + ')');
    modalRoot.innerHTML='';
    render();
  });
  box.querySelector('#mDet').addEventListener('click', ()=>{
    try{
      const M = readMatrixFromBox(box);
      const det = math.det(M);
      box.querySelector('#mOut').textContent = 'det = ' + format(det);
    }catch(e){ box.querySelector('#mOut').textContent = 'Err: ' + e.message; }
  });
  box.querySelector('#mInv').addEventListener('click', ()=>{
    try{
      const M = readMatrixFromBox(box);
      const inv = math.inv(M);
      box.querySelector('#mOut').textContent = 'inv = ' + JSON.stringify(inv);
    }catch(e){ box.querySelector('#mOut').textContent = 'Err: ' + e.message; }
  });

  build();

  function readMatrixFromBox(box){
    const inputs = box.querySelectorAll('#mGrid input');
    if(!inputs.length) throw new Error('No matrix');
    const rows = Math.max(...Array.from(inputs).map(i=>Number(i.dataset.r)))+1;
    const cols = Math.max(...Array.from(inputs).map(i=>Number(i.dataset.c)))+1;
    const M=[];
    for(let i=0;i<rows;i++){
      const r=[]; for(let j=0;j<cols;j++){
        const v = box.querySelector(`input[data-r="${i}"][data-c="${j}"]`).value || '0';
        r.push(Number(v));
      }
      M.push(r);
    }
    return M;
  }
}

/* STAT editor */
function openStat(){
  modalRoot.innerHTML='';
  const box = document.createElement('div');
  box.style.background='#021219'; box.style.padding='12px'; box.style.border='1px solid #094'; box.style.borderRadius='8px';
  box.innerHTML = `<h3 style="margin:0;color:#8df">STAT Editor</h3>
    <div style="margin-top:8px"><textarea id="sList" rows=4 style="width:100%;background:#041018;border:1px solid #083;color:#dff">1,2,3,4,5</textarea></div>
    <div style="margin-top:8px"><button id="sMean" class="small-btn">Mean</button> <button id="sMed" class="small-btn">Median</button> <button id="sStd" class="small-btn">Std</button> <button id="sClose" class="small-btn">Close</button></div>
    <div id="sOut" style="margin-top:8px;color:#9bf"></div>`;
  modalRoot.appendChild(box);
  box.querySelector('#sMean').addEventListener('click', ()=> {
    const arr = parseList(box.querySelector('#sList').value);
    box.querySelector('#sOut').textContent = 'Mean: ' + format(math.mean(arr));
  });
  box.querySelector('#sMed').addEventListener('click', ()=> {
    const arr = parseList(box.querySelector('#sList').value);
    box.querySelector('#sOut').textContent = 'Median: ' + format(math.median(arr));
  });
  box.querySelector('#sStd').addEventListener('click', ()=> {
    const arr = parseList(box.querySelector('#sList').value);
    box.querySelector('#sOut').textContent = 'Std: ' + format(math.std(arr));
  });
  box.querySelector('#sClose').addEventListener('click', ()=> modalRoot.innerHTML='');

  function parseList(s){
    return s.split(',').map(x=>Number(x.trim())).filter(x=>!isNaN(x));
  }
}

/* Equation solver */
function openEq(){
  modalRoot.innerHTML='';
  const box = document.createElement('div');
  box.style.background='#021219'; box.style.padding='12px'; box.style.border='1px solid #094'; box.style.borderRadius='8px';
  box.innerHTML = `<h3 style="margin:0;color:#8df">Equation Solver</h3>
    <div style="margin-top:8px"><button id="lin" class="small-btn">Linear ax+b=0</button> <button id="quad" class="small-btn">Quadratic ax¬≤+bx+c</button> <button id="sys" class="small-btn">Linear System</button> <button id="close" class="small-btn">Close</button></div>
    <div id="out" style="margin-top:8px;color:#9bf"></div>`;
  modalRoot.appendChild(box);
  box.querySelector('#lin').addEventListener('click', ()=> {
    const a=Number(prompt('a')); const b=Number(prompt('b'));
    if(a===0) box.querySelector('#out').textContent='No solution (a=0)';
    else box.querySelector('#out').textContent='x=' + format(-b/a);
  });
  box.querySelector('#quad').addEventListener('click', ()=>{
    const a=Number(prompt('a')); const b=Number(prompt('b')); const c=Number(prompt('c'));
    let D=b*b-4*a*c;
    if(D>=0){
      box.querySelector('#out').textContent=`x1=${format((-b+Math.sqrt(D))/(2*a))} x2=${format((-b-Math.sqrt(D))/(2*a))}`;
    }else{
      box.querySelector('#out').textContent=`x1=${format(math.complex(-b/(2*a),Math.sqrt(-D)/(2*a)))} x2=${format(math.complex(-b/(2*a),-Math.sqrt(-D)/(2*a)))}`;
    }
  });
  box.querySelector('#sys').addEventListener('click', ()=>{
    const n = Number(prompt('Number of equations (2-4)',2));
    if(!n||n<2||n>4){ alert('Invalid'); return; }
    const A=[]; const b=[];
    for(let i=0;i<n;i++){
      const row = prompt(`Row ${i+1} coefficients comma separated (n numbers)`);
      A.push(row.split(',').map(x=>Number(x.trim())));
    }
    for(let i=0;i<n;i++){ b.push(Number(prompt(`b[${i+1}]`))); }
    try{
      const sol = math.lusolve(A,b);
      box.querySelector('#out').textContent = 'Solution: ' + JSON.stringify(sol.map(x=>x[0]));
    }catch(e){ box.querySelector('#out').textContent = 'Err: '+ e.message; }
  });
  box.querySelector('#close').addEventListener('click', ()=> modalRoot.innerHTML='');
}

/* Base converter */
function openBase(){
  modalRoot.innerHTML='';
  const box = document.createElement('div');
  box.style.background='#021219'; box.style.padding='12px'; box.style.border='1px solid #094'; box.style.borderRadius='8px';
  box.innerHTML = `<h3 style="margin:0;color:#8df">Base Converter</h3>
    <div style="margin-top:8px"><input id="bVal" placeholder="value (e.g. 255 or 0xFF or 0b1010)"></div>
    <div style="margin-top:8px"><select id="from"><option value="0">Auto</option><option value="2">BIN</option><option value="8">OCT</option><option value="10" selected>DEC</option><option value="16">HEX</option></select>
    <select id="to"><option value="2">BIN</option><option value="8">OCT</option><option value="10">DEC</option><option value="16">HEX</option></select>
    <button id="bConv" class="small-btn">Convert</button> <button id="bClose" class="small-btn">Close</button></div>
    <div id="bOut" style="margin-top:8px;color:#9bf"></div>`;
  modalRoot.appendChild(box);
  box.querySelector('#bConv').addEventListener('click', ()=>{
    const v = box.querySelector('#bVal').value.trim();
    const fm = Number(box.querySelector('#from').value);
    const to = Number(box.querySelector('#to').value);
    try{
      let num;
      if(fm===0){
        if(v.startsWith('0b')) num = BigInt(parseInt(v.slice(2),2));
        else if(v.startsWith('0x')) num = BigInt(parseInt(v.slice(2),16));
        else num = BigInt(v);
      }else num = BigInt(parseInt(v, fm));
      let out;
      if(to===10) out = num.toString(10);
      else if(to===2) out = '0b' + num.toString(2);
      else if(to===8) out = '0o' + num.toString(8);
      else if(to===16) out = '0x' + num.toString(16).toUpperCase();
      box.querySelector('#bOut').textContent = out;
    }catch(e){ box.querySelector('#bOut').textContent = 'Err: ' + e.message; }
  });
  box.querySelector('#bClose').addEventListener('click', ()=> modalRoot.innerHTML='');
}

/* helper: check compute key */
function keyIsCompute(k){ return k==='=' || k==='='; }

/* export/import */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const payload = JSON.stringify({expr:S.expr,ans:S.ans,mem:S.mem,vars:S.vars,history:S.history});
  const blob = new Blob([payload], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='casio_emu_export.json'; a.click();
});
document.getElementById('importBtn').addEventListener('click', ()=>{
  const txt = prompt('Paste JSON export here:');
  if(!txt) return;
  try{
    const p = JSON.parse(txt);
    S.expr = p.expr || '0'; S.ans = p.ans || 0; S.mem = p.mem || 0; S.vars = p.vars || S.vars; S.history = p.history || [];
    render();
    alert('Imported');
  }catch(e){ alert('Import failed: ' + e.message); }
});

/* editors openers */
document.getElementById('openMatrix').addEventListener('click', openMatrix);
document.getElementById('openStat').addEventListener('click', openStat);
document.getElementById('openEq').addEventListener('click', openEq);
document.getElementById('openBase').addEventListener('click', openBase);

/* history controls */
document.getElementById('openHistory').addEventListener('click', ()=> {
  alert('History length: ' + S.history.length + '\\nMost recent: ' + (S.history[0]? S.history[0].expr + ' = ' + format(S.history[0].res) : 'none'));
});
document.getElementById('clearHistory').addEventListener('click', ()=> { S.history = []; render(); });

/* keyboard support (basic) */
window.addEventListener('keydown', (e)=>{
  const k = e.key;
  if(k==='Shift') { S.shift = true; render(); return; }
  if(k==='Enter') { compute(); return; }
  if(k==='Backspace'){ if(S.expr.length<=1) S.expr='0'; else S.expr=S.expr.slice(0,-1); render(); return; }
  if(/^[0-9+\-*/^().]$/.test(k)) { appendRaw(k); render(); return; }
});

/* utility: nPr/nCr and factorial using math.js; attach functions to math */
math.import({
  nCr: function(n,r){ return math.combinations(n,r); },
  nPr: function(n,r){ return math.factorial(n)/math.factorial(n-r); },
  perm: function(n,r){ return math.factorial(n)/math.factorial(n-r); },
  comb: function(n,r){ return math.combinations(n,r); },
  reciprocal: function(x){ return 1/x; }
}, {override: true});

/* initial render */
render();

</script>
</body>
</html>
