<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Flappy Birch — Multiplayer (Firebase)</title>
<style>
  *{box-sizing:border-box;font-family:system-ui,Arial;}
  html,body{height:100%;margin:0;background:#87ceeb;touch-action:manipulation;user-select:none;}
  .wrap{max-width:920px;margin:12px auto;padding:12px;}
  .panel{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.12);}
  .row{display:flex;gap:8px;align-items:center;margin-top:8px;}
  input,select,button{padding:10px;border-radius:8px;border:1px solid #ccc;}
  button{background:#046;color:#fff;border:0;font-weight:700;}
  #gameArea{margin-top:12px;position:relative;height:520px;overflow:hidden;border-radius:8px;}
  canvas{width:100%;height:100%;display:block;background:linear-gradient(#87ceeb,#5cc1ff);}
  #overlayTop{position:absolute;left:10px;top:10px;z-index:10;}
  .chip{display:inline-block;background:rgba(255,255,255,0.92);padding:6px 8px;border-radius:999px;margin-right:6px;font-weight:700;}
  #deathOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:40;}
  #deathBox{background:#fff;padding:14px;border-radius:8px;text-align:center;}
  #playersList{margin-top:8px;font-size:14px;}
  .small{font-size:13px;color:#333;}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel" id="lobbyPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0">Flappy Birch — Multiplayer</h3>
      <div class="small">Creator default: <strong>Bindz</strong></div>
    </div>

    <div class="row">
      <input id="nameInput" placeholder="Tên (nhập hoặc để trống để dùng mặc định)" style="flex:1" />
      <select id="modeSelect"><option value="shared">Shared (xem chim nhau)</option><option value="solo">Solo (chỉ bạn)</option></select>
      <button id="btnCreate">Create</button>
    </div>

    <div class="row">
      <input id="joinInput" placeholder="Nhập mã phòng 4 ký tự" style="width:180px" />
      <button id="btnJoin">Join</button>
      <button id="btnStart" style="display:none">Start</button>
    </div>

    <div id="roomInfo" class="small" style="margin-top:8px">Room: -</div>
    <div id="playersList" class="small"></div>
  </div>

  <div id="gameArea" class="panel" style="display:none;">
    <div id="overlayTop">
      <span class="chip" id="roomChip">Room:-</span>
      <span class="chip" id="meChip">You:-</span>
      <span class="chip" id="scoreChip">Score:0</span>
    </div>
    <canvas id="canvas" width="900" height="520"></canvas>

    <div id="deathOverlay">
      <div id="deathBox">
        <h3>BẠN ĐÃ CHẾT</h3>
        <div style="margin-top:8px"><button id="btnReset">Reset</button></div>
      </div>
    </div>
  </div>

  <div class="small" style="margin-top:8px">Chạm màn hình để flap. Nếu chưa paste Firebase config, bản này vẫn cho phép chơi solo thử.</div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ------------------- PASTE FIREBASE CONFIG Ở ĐÂY -------------------
  Tạo project Firebase -> Realtime Database (test mode) -> copy config SDK
  Dán vào firebaseConfig dưới đây (thay các giá trị REPLACE_...).
*/
const firebaseConfig = {
  apiKey: "REPLACE_API_KEY",
  authDomain: "REPLACE_PROJECT.firebaseapp.com",
  databaseURL: "https://REPLACE_PROJECT-default-rtdb.firebaseio.com",
  projectId: "REPLACE_PROJECT",
  storageBucket: "REPLACE_PROJECT.appspot.com",
  messagingSenderId: "REPLACE_ID",
  appId: "REPLACE_APPID"
};
/* ------------------------------------------------------------------ */

let useFirebase = !(firebaseConfig.apiKey.includes('REPLACE'));
if(useFirebase) {
  firebase.initializeApp(firebaseConfig);
}
const db = useFirebase ? firebase.database() : null;

/* ------------------- UI & state ------------------- */
const nameInput = document.getElementById('nameInput');
const btnCreate = document.getElementById('btnCreate');
const btnJoin = document.getElementById('btnJoin');
const btnStart = document.getElementById('btnStart');
const joinInput = document.getElementById('joinInput');
const roomInfo = document.getElementById('roomInfo');
const playersListEl = document.getElementById('playersList');
const modeSelect = document.getElementById('modeSelect');

const gameArea = document.getElementById('gameArea');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const roomChip = document.getElementById('roomChip');
const meChip = document.getElementById('meChip');
const scoreChip = document.getElementById('scoreChip');
const deathOverlay = document.getElementById('deathOverlay');
const btnReset = document.getElementById('btnReset');

let roomId = null;
let playerId = null;
let myName = '';
let isHost = false;
let mode = 'shared';
let players = {}; // id -> bird
let pipes = [];
let pipeTimer = 0;
let gravity = 0.45, flapPower = -8;
let gameRunning = false;
let syncInterval = null;

/* ------------------- helpers ------------------- */
const randId = ()=> 'p' + Math.random().toString(36).slice(2,9);
const genRoom = ()=> Math.random().toString(36).slice(2,6).toUpperCase();
const colorRand = ()=> '#'+Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,'0');
function bird(id,name,color){ return {id:id,name:name,x:150,y:canvas.height/2,vy:0,w:34,h:24,color:color||colorRand(),alive:true,score:0,passed:-1}; }

/* ------------------- rendering & physics ------------------- */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // ground
  ctx.fillStyle='#6b3'; ctx.fillRect(0,canvas.height-50,canvas.width,50);
  // pipes
  for(const p of pipes){ ctx.fillStyle='#2b8'; ctx.fillRect(p.x,0,52,p.top); ctx.fillRect(p.x,p.top+p.gap,52,canvas.height-(p.top+p.gap)-50); }
  // birds
  for(const id in players){
    const b = players[id];
    if(!b) continue;
    ctx.fillStyle = b.color; ctx.beginPath(); ctx.ellipse(b.x,b.y,b.w/2,b.h/2,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#000'; ctx.fillRect(b.x+6,b.y-4,4,4);
    ctx.font='14px system-ui'; ctx.textAlign='center'; ctx.fillStyle='#000'; ctx.fillText(b.name, b.x, b.y-28);
  }
}
function spawnPipe(){ pipes.push({x:canvas.width+40, top: Math.floor(Math.random()*(canvas.height-200-140))+60, gap:140}); }
function updatePipes(){ for(const p of pipes) p.x -= 2.6; if(pipes.length && pipes[0].x < -80) pipes.shift(); }

function physicsTick(){
  if(!gameRunning) return;
  if(isHost && mode==='shared'){
    pipeTimer++; if(pipeTimer>110){ spawnPipe(); pipeTimer=0; if(useFirebase) db.ref('rooms/'+roomId+'/pipes').set(pipes); }
  }
  updatePipes();
  for(const id in players){
    const b = players[id];
    if(!b.alive) continue;
    b.vy += gravity;
    b.y += b.vy;
    if(b.y + b.h/2 >= canvas.height-50){ b.alive=false; onDeath(id); }
    if(b.y - b.h/2 <= 0){ b.y = b.h/2; b.vy = 0; }
    // collision & scoring
    for(const p of pipes){
      if(b.x + b.w/2 > p.x && b.x - b.w/2 < p.x + 52){
        if(b.y - b.h/2 < p.top || b.y + b.h/2 > p.top + p.gap){ b.alive=false; onDeath(id); }
      } else {
        if(b.passed < pipes.indexOf(p) && b.x > p.x + 52){
          b.passed = pipes.indexOf(p); b.score = (b.score||0)+1;
          if(isHost && mode==='shared' && useFirebase) db.ref('rooms/'+roomId+'/players/'+id+'/score').set(b.score);
          if(id === playerId) scoreChip.textContent = 'Score:' + b.score;
        }
      }
    }
  }
  if(isHost && mode==='shared' && useFirebase) db.ref('rooms/'+roomId+'/players').set(players);
  render();
}

/* ------------------- death / reset ------------------- */
function onDeath(id){
  if(useFirebase && mode==='shared') db.ref('rooms/'+roomId+'/players/'+id+'/alive').set(false);
  if(id === playerId) deathOverlay.style.display = 'flex';
}
function resetLocal(){
  if(!players[playerId]) return;
  players[playerId].y = canvas.height/2; players[playerId].vy = 0; players[playerId].alive = true; players[playerId].score = 0; players[playerId].passed = -1;
  scoreChip.textContent = 'Score:0'; deathOverlay.style.display = 'none';
  if(useFirebase && mode==='shared') db.ref('rooms/'+roomId+'/players/'+playerId).set(players[playerId]);
}

/* ------------------- input ------------------- */
function flap(){
  if(!players[playerId] || !players[playerId].alive) return;
  players[playerId].vy = flapPower;
  if(useFirebase && mode==='shared') db.ref('rooms/'+roomId+'/players/'+playerId+'/y').set(players[playerId].y);
}
window.addEventListener('keydown', e=>{ if(e.code==='Space') flap(); });
canvas.addEventListener('touchstart', e=>{ e.preventDefault(); flap(); }, {passive:false});
canvas.addEventListener('mousedown', ()=> flap());

/* ------------------- UI helpers ------------------- */
function renderPlayersList(){
  playersListEl.innerHTML = '';
  for(const id in players){
    const p = players[id];
    const el = document.createElement('div');
    el.textContent = p.name + (id===playerId ? ' (You)' : '') + ' — ' + (p.score||0) + (p.alive ? '' : ' (dead)');
    playersListEl.appendChild(el);
  }
}

/* ------------------- Firebase networking ------------------- */
let playersRef=null, pipesRef=null, runningRef=null;
function attachRoomListeners(){
  if(!useFirebase) return;
  if(playersRef) playersRef.off();
  playersRef = db.ref('rooms/'+roomId+'/players');
  playersRef.on('value', snap => {
    const data = snap.val() || {};
    // merge
    for(const id in data){
      const d = data[id];
      if(!players[id]) players[id] = bird(id,d.name,d.color||colorRand());
      players[id].name = d.name; players[id].score = d.score||0; players[id].alive = (d.alive===undefined ? players[id].alive : d.alive); players[id].color = d.color || players[id].color;
      if(!isHost && id !== playerId){
        players[id].x = d.x || players[id].x; players[id].y = d.y || players[id].y; players[id].vy = d.vy || players[id].vy;
      }
    }
    for(const id in players) if(!data[id]) delete players[id];
    renderPlayersList();
  });

  if(pipesRef) pipesRef.off();
  pipesRef = db.ref('rooms/'+roomId+'/pipes');
  pipesRef.on('value', snap => { pipes = snap.val() || []; });

  if(runningRef) runningRef.off();
  runningRef = db.ref('rooms/'+roomId+'/running');
  runningRef.on('value', snap => {
    const val = snap.val();
    if(val){
      // start game for everyone
      lobbyPanel.style.display = 'none';
      gameArea.style.display = 'block';
      if(isHost) startHostLoop(); else startClientLoop();
    }
  });
}

/* ------------------- Create / Join / Start handlers ------------------- */
btnCreate.addEventListener('click', async ()=>{
  mode = modeSelect.value;
  myName = (nameInput.value||'').trim() || 'Bindz';
  playerId = randId();
  isHost = true;
  roomId = genRoom();
  roomInfo.textContent = 'Room: ' + roomId + ' (host)';
  roomChip.textContent = 'Room:' + roomId;
  meChip.textContent = 'You:' + myName + ' (Host)';
  // init players
  players = {}; players[playerId] = bird(playerId,myName,colorRand());
  // write to DB if available
  if(useFirebase){
    await db.ref('rooms/'+roomId).set({mode:mode, createdAt:Date.now(), host:playerId});
    await db.ref('rooms/'+roomId+'/players/'+playerId).set(players[playerId]);
    await db.ref('rooms/'+roomId+'/pipes').set(pipes);
    attachRoomListeners();
  } else {
    // local fallback: still show lobby and permit Start for solo testing
    attachRoomListeners();
  }
  btnStart.style.display = 'inline-block';
  renderPlayersList();
});

btnJoin.addEventListener('click', async ()=>{
  const code = (joinInput.value||'').trim().toUpperCase();
  if(!code){ alert('Nhập mã phòng 4 ký tự'); return; }
  if(useFirebase){
    const snap = await db.ref('rooms/'+code).get();
    if(!snap.exists()){ alert('Phòng không tồn tại'); return; }
    roomId = code; mode = snap.val().mode || 'shared';
    myName = (nameInput.value||'').trim() || ('Guest'+Math.floor(Math.random()*99));
    playerId = randId();
    isHost = false;
    players[playerId] = bird(playerId,myName,colorRand());
    roomInfo.textContent = 'Room: ' + roomId + ' (joined)';
    roomChip.textContent = 'Room:' + roomId; meChip.textContent = 'You:' + myName;
    await db.ref('rooms/'+roomId+'/players/'+playerId).set(players[playerId]);
    attachRoomListeners();
    btnStart.style.display = 'none';
    // do not auto start; wait for host or allow host to start alone
  } else {
    alert('Chưa có Firebase config — bạn có thể thử Create để chơi solo thử.');
  }
});

btnStart.addEventListener('click', async ()=>{
  // host can start even nếu không ai vào
  if(!isHost){ alert('Chỉ host mới Start được'); return; }
  if(useFirebase) await db.ref('rooms/'+roomId+'/running').set(true);
  else { // local fallback
    lobbyPanel.style.display = 'none'; gameArea.style.display = 'block'; startHostLoop();
  }
});

/* ------------------- game loops ------------------- */
function startHostLoop(){
  if(syncInterval) clearInterval(syncInterval);
  gameRunning = true; isHost = true;
  syncInterval = setInterval(()=> physicsTick(), 1000/60);
  requestAnimationFrame(loopRender);
}
function startClientLoop(){
  if(syncInterval) clearInterval(syncInterval);
  gameRunning = true;
  syncInterval = setInterval(()=> physicsTick(), 1000/60);
  requestAnimationFrame(loopRender);
}
function loopRender(){ render(); if(gameRunning) requestAnimationFrame(loopRender); }

/* ------------------- reset / leave ------------------- */
btnReset.addEventListener('click', ()=> resetLocal());
window.addEventListener('beforeunload', ()=> {
  if(useFirebase && roomId && playerId){ try{ db.ref('rooms/'+roomId+'/players/'+playerId).remove(); }catch(e){} }
});

/* ------------------- periodic client update (send own y to db) ------------------- */
setInterval(()=> {
  if(!roomId || !playerId) return;
  if(useFirebase && !isHost && mode==='shared' && players[playerId]){
    db.ref('rooms/'+roomId+'/players/'+playerId+'/y').set(players[playerId].y);
    db.ref('rooms/'+roomId+'/players/'+playerId+'/vy').set(players[playerId].vy);
  }
}, 200);

/* ------------------- allow quick single-player test if no firebase config ------------------- */
if(!useFirebase){
  roomInfo.textContent = 'Bạn chưa paste Firebase config. Dùng Create để test solo (local only).';
}

/* ------------------- initial render ------------------- */
render();
</script>
</body>
</html>
