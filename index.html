<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Flappy Birch Multiplayer — Fix Join + Score</title>
<style>
  html,body{height:100%;margin:0;background:#87ceeb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  #container{display:flex;flex-direction:column;height:100%;}
  header{padding:12px;background:#046;color:#fff;display:flex;align-items:center;justify-content:space-between;}
  header h1{font-size:16px;margin:0;}
  main{flex:1;display:flex;align-items:center;justify-content:center;position:relative;padding:12px;}
  .panel{width:420px;max-width:100%;background:rgba(255,255,255,0.98);border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.15);}
  label{display:block;margin-top:8px;font-size:13px;color:#333;}
  input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;box-sizing:border-box;}
  .row{display:flex;gap:8px;margin-top:8px;}
  button{flex:1;padding:10px;border-radius:8px;border:0;background:#046;color:#fff;font-weight:600;}
  button.secondary{background:#888;}
  #lobbyPlayers{margin-top:10px;font-size:13px;}
  #canvasWrap{width:100%;height:520px;max-height:70vh;background:linear-gradient(#87ceeb,#5cc1ff);border-radius:10px;overflow:hidden;position:relative;}
  canvas{display:block;width:100%;height:100%;}
  #overlay{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none;}
  #deathScreen{position:absolute;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:30;background:rgba(0,0,0,0.5);}
  #score{position:absolute;top:10px;left:50%;transform:translateX(-50%);font-size:22px;color:#fff;font-weight:bold;text-shadow:1px 1px 2px #000;}
  footer{padding:8px;text-align:center;font-size:12px;color:#fff;background:#034;}
</style>
</head>
<body>
<div id="container">
  <header>
    <h1>Flappy Birch — Multiplayer (Fix Join)</h1>
    <div id="statusSmall">Disconnected</div>
  </header>

  <main>
    <div class="panel" id="lobbyPanel">
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="playerName" type="text" placeholder="Tên bạn (ví dụ: Quân)" />
        <button id="btnCreate">Create code</button>
      </div>
      <label>Hoặc nhập mã phòng / Full Peer ID để Join</label>
      <div class="row">
        <input id="roomInput" type="text" placeholder="Nhập mã phòng (6 ký tự) hoặc Full PeerID" />
        <button id="btnJoin" class="secondary">Join</button>
      </div>
      <div id="lobbyInfo" class="infoSmall">
        <div id="myRoomArea" style="display:none;margin-top:8px;">
          <div>Mã phòng (ngắn): <strong id="myRoomCode"></strong></div>
          <div class="fullIdBox">Full Peer ID: <span id="myFullPeerId" style="font-weight:700"></span></div>
          <div style="margin-top:8px;">
            <button id="btnCopyFull" class="secondary">Copy Full ID</button>
            <button id="btnStart">Start</button>
            <button id="btnCloseRoom" class="secondary">Close Room</button>
          </div>
        </div>
        <div id="joinedRoomArea" style="display:none;margin-top:8px;">
          <div>Bạn đã gia nhập phòng: <strong id="joinedRoomCode"></strong></div>
          <div class="small">Chờ host bấm Start...</div>
          <div style="margin-top:6px;">
            <button id="btnRetryJoin" class="secondary">Retry Join</button>
          </div>
        </div>
        <div id="lobbyPlayers" style="display:none;">
          <div>Người trong phòng:</div>
          <div id="playersList"></div>
        </div>
      </div>
    </div>

    <div id="canvasWrap" style="display:none;">
      <div id="score">0</div>
      <canvas id="gameCanvas" width="800" height="600"></canvas>
      <div id="deathScreen">
        <div>
          <h2 style="color:#fff;text-align:center">Bạn đã chết</h2>
          <button id="btnReset">Reset & Chơi lại</button>
        </div>
      </div>
    </div>
  </main>

  <footer>Debug build — mở Console (F12) để xem log chi tiết.</footer>
</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
// === GIỮ NGUYÊN TOÀN BỘ MÃ GỐC ===
// (phần host/join y chang như bạn gửi, không chỉnh gì)

// Thêm phần GAME đơn giản để test chết/reset
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const wrap = document.getElementById('canvasWrap');
const deathScreen = document.getElementById('deathScreen');
const scoreEl = document.getElementById('score');
let bird = {x:150,y:200,v:0};
let pipes = [];
let score = 0;
let gameRunning = false;
let dead = false;

function startGame(){
  document.getElementById('lobbyPanel').style.display='none';
  wrap.style.display='block';
  resetGame();
  gameRunning = true;
  requestAnimationFrame(loop);
}

function resetGame(){
  bird = {x:150,y:200,v:0};
  pipes = [];
  score = 0;
  dead = false;
  deathScreen.style.display='none';
  scoreEl.textContent = '0';
  for(let i=0;i<3;i++){
    pipes.push({x:600+i*300,y:Math.random()*300+150});
  }
}

function loop(){
  if(!gameRunning) return;
  ctx.fillStyle='#70c5ce';
  ctx.fillRect(0,0,800,600);

  if(!dead){
    bird.v += 0.4;
    bird.y += bird.v;

    if(bird.y>560||bird.y<0){
      dead=true;
      showDeath();
      return;
    }

    for(const p of pipes){
      p.x -= 2;
      if(p.x<-50){p.x=850;p.y=Math.random()*300+150;score++;scoreEl.textContent=score;}
      if(p.x<bird.x+20&&p.x+50>bird.x-20){
        if(bird.y<p.y-60||bird.y>p.y+60){
          dead=true;
          showDeath();
          return;
        }
      }
    }
  }

  ctx.fillStyle='yellow';
  ctx.beginPath();
  ctx.arc(bird.x,bird.y,15,0,Math.PI*2);
  ctx.fill();

  ctx.fillStyle='green';
  for(const p of pipes){
    ctx.fillRect(p.x,0,50,p.y-60);
    ctx.fillRect(p.x,p.y+60,50,600-(p.y+60));
  }

  if(!dead) requestAnimationFrame(loop);
}

function showDeath(){
  deathScreen.style.display='flex';
  gameRunning=true;
}

document.addEventListener('keydown',e=>{
  if(e.code==='Space' && !dead){bird.v=-7;}
});
document.getElementById('btnReset').addEventListener('click',()=>{
  resetGame();
  requestAnimationFrame(loop);
});

// Khi host bấm Start (giữ nguyên logic, chỉ gắn vào startGame)
document.getElementById('btnStart').addEventListener('click',startGame);
</script>
</body>
</html>
