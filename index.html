<!-- (Phần đầu bạn giữ nguyên y chang — từ <!doctype html> đến hết script cũ) -->

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
/* ... nguyên toàn bộ script bạn gửi ở trên ... */
/* (không đổi gì, không xóa gì) */

/* Reset placeholder */
btnReset.addEventListener('click', ()=> { location.reload(); });

/* cleanup when leaving */
window.addEventListener('beforeunload', ()=> { try{ if(peer) peer.destroy(); }catch(e){} });


// === FLAPPY GAME START ===
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const wrap = document.getElementById('canvasWrap');
const deathScreen = document.getElementById('deathScreen');
let gameRunning = false;
let birds = {};
let pipes = [];
let gravity = 0.35, flapPower = -6, pipeGap = 130, pipeSpeed = 2;
let myBird = null, score = 0, frame = 0;

function startFlappy(){
  document.getElementById('lobbyPanel').style.display = 'none';
  wrap.style.display = 'block';
  initGame();
}

function initGame(){
  birds = {};
  pipes = [];
  score = 0;
  frame = 0;
  myBird = {
    id: myPeerId,
    name: players[myPeerId]?.name || 'You',
    x: 150,
    y: canvas.height/2,
    vy: 0,
    dead: false,
    color: isHost ? '#ff0' : '#0ff',
    score: 0
  };
  birds[myPeerId] = myBird;
  gameRunning = true;
  deathScreen.style.display = 'none';
  loop();
}

function flap(){
  if(myBird && !myBird.dead) myBird.vy = flapPower;
}
canvas.addEventListener('touchstart', flap);
canvas.addEventListener('mousedown', flap);

function loop(){
  if(!gameRunning) return;
  frame++;
  update();
  draw();
  requestAnimationFrame(loop);
}

function update(){
  if(frame % 90 === 0){
    const top = Math.random() * (canvas.height - pipeGap - 100) + 50;
    pipes.push({x: canvas.width, top: top, bottom: top + pipeGap});
  }
  for(let p of pipes) p.x -= pipeSpeed;
  pipes = pipes.filter(p => p.x > -60);
  for(let id in birds){
    const b = birds[id];
    if(!b.dead){
      b.vy += gravity;
      b.y += b.vy;
      for(let p of pipes){
        if(b.x + 24 > p.x && b.x - 24 < p.x + 60){
          if(b.y - 12 < p.top || b.y + 12 > p.bottom){
            b.dead = true;
            if(id === myPeerId) onDie();
          }
        }
      }
      if(b.y > canvas.height - 24 || b.y < 0){
        b.dead = true;
        if(id === myPeerId) onDie();
      }
      if(!b.dead && id === myPeerId){
        for(let p of pipes){
          if(!p.passed && p.x + 60 < b.x){
            p.passed = true;
            score++;
            b.score = score;
          }
        }
      }
    }
  }
  if(myBird && !myBird.dead) broadcast({type:'sync', bird: myBird});
}

function draw(){
  ctx.fillStyle = '#87ceeb';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#4ec04e';
  ctx.fillRect(0,canvas.height-30,canvas.width,30);
  ctx.fillStyle = '#2a9d8f';
  for(let p of pipes){
    ctx.fillRect(p.x, 0, 60, p.top);
    ctx.fillRect(p.x, p.bottom, 60, canvas.height - p.bottom);
  }
  for(let id in birds){
    const b = birds[id];
    ctx.fillStyle = b.color;
    ctx.beginPath();
    ctx.arc(b.x, b.y, 12, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#000';
    ctx.font = 'bold 14px Arial';
    ctx.fillText(`${b.name} (${b.score||0})`, b.x - 30, b.y - 20);
  }
}

function onDie(){
  myBird.dead = true;
  gameRunning = false;
  deathScreen.style.display = 'flex';
}

/* Khi host bấm START thì bắt đầu game */
btnStart.addEventListener('click', ()=> {
  if(isHost){
    broadcast({type:'start'});
    startFlappy();
  }
});

/* Khi client nhận START từ host */
function handleClientMessage(data){
  if(!data || !data.type) return;
  if(data.type === 'lobby-list'){
    players = {};
    for(const p of data.players) players[p.id] = {id:p.id, name:p.name};
    renderLobbyList();
  } else if(data.type === 'player-joined'){
    players[data.id] = {id:data.id, name:data.name};
    renderLobbyList();
  } else if(data.type === 'start'){
    startFlappy();
  } else if(data.type === 'sync'){
    const b = data.bird;
    if(b && b.id !== myPeerId){
      birds[b.id] = b;
    }
  }
}

// === FLAPPY GAME END ===
</script>
</body>
</html>
