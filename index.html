<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Flappy Birch Multiplayer — Full Stable</title>
<style>
  html,body{height:100%;margin:0;background:#87ceeb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden;}
  #container{display:flex;flex-direction:column;height:100%;}
  header{padding:12px;background:#046;color:#fff;display:flex;align-items:center;justify-content:space-between;}
  header h1{font-size:16px;margin:0;}
  main{flex:1;display:flex;align-items:center;justify-content:center;position:relative;padding:12px;}
  .panel{width:420px;max-width:100%;background:rgba(255,255,255,0.98);border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.15);}
  label{display:block;margin-top:8px;font-size:13px;color:#333;}
  input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;box-sizing:border-box;}
  .row{display:flex;gap:8px;margin-top:8px;}
  button{flex:1;padding:10px;border-radius:8px;border:0;background:#046;color:#fff;font-weight:600;}
  button.secondary{background:#888;}
  #lobbyPlayers{margin-top:10px;font-size:13px;}
  #canvasWrap{width:100%;height:520px;max-height:70vh;background:linear-gradient(#87ceeb,#5cc1ff);border-radius:10px;overflow:hidden;position:relative;display:none;}
  canvas{display:block;width:100%;height:100%;}
  #deathScreen{position:absolute;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:30;background:rgba(0,0,0,0.5);}
  #score{position:absolute;top:10px;left:50%;transform:translateX(-50%);font-size:22px;color:#fff;font-weight:bold;text-shadow:1px 1px 2px #000;}
  footer{padding:8px;text-align:center;font-size:12px;color:#fff;background:#034;}
</style>
</head>
<body>
<div id="container">
  <header>
    <h1>Flappy Birch Multiplayer</h1>
    <div id="statusSmall">Disconnected</div>
  </header>

  <main>
    <div class="panel" id="lobbyPanel">
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="playerName" type="text" placeholder="Tên bạn (ví dụ: Bindz)" />
        <button id="btnCreate">Create</button>
      </div>

      <label>Hoặc nhập mã phòng để Join</label>
      <div class="row">
        <input id="roomInput" type="text" placeholder="Nhập mã phòng (6 ký tự)" />
        <button id="btnJoin" class="secondary">Join</button>
      </div>

      <div id="lobbyInfo" class="infoSmall">
        <div id="myRoomArea" style="display:none;margin-top:8px;">
          <div>Mã phòng: <strong id="myRoomCode"></strong></div>
          <div style="margin-top:8px;">
            <button id="btnStart">Start</button>
          </div>
        </div>

        <div id="joinedRoomArea" style="display:none;margin-top:8px;">
          <div>Bạn đã vào phòng: <strong id="joinedRoomCode"></strong></div>
          <div class="small">Chờ host bấm Start...</div>
        </div>

        <div id="lobbyPlayers" style="display:none;">
          <div>Người trong phòng:</div>
          <div id="playersList"></div>
        </div>
      </div>
    </div>

    <div id="canvasWrap">
      <canvas id="gameCanvas" width="800" height="600"></canvas>
      <div id="score">0</div>
      <div id="deathScreen">
        <div>
          <h2 style="color:white;">Bạn đã chết</h2>
          <button id="btnReset">Chơi lại</button>
        </div>
      </div>
    </div>
  </main>

  <footer>Flappy Birch — Multiplayer Test</footer>
</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
const $ = id=>document.getElementById(id);
let peer, conn, isHost=false, players={}, roomCode=null;
let myId=null, myName=null;
const canvas=$("gameCanvas"), ctx=canvas.getContext("2d");
let gravity=0.5, flap=-8;
let birds={}, pipes=[], score=0, gameOver=false;
let lastPipe=0;

// ======= LOBBY =========
$("btnCreate").onclick=()=>{
  myName=$("playerName").value||"Bindz";
  isHost=true;
  peer=new Peer(undefined,{secure:true,debug:2});
  peer.on("open",id=>{
    myId=id; roomCode=id.slice(0,6).toUpperCase();
    $("myRoomCode").textContent=roomCode;
    $("myRoomArea").style.display="block";
    $("lobbyPlayers").style.display="block";
    $("statusSmall").textContent="Hosting "+roomCode;
    players[myId]={name:myName};
    renderPlayers();
  });
  peer.on("connection",c=>{
    conn=c;
    c.on("open",()=>{
      c.on("data",d=>{
        if(d.type=="join"){players[d.id]={name:d.name}; renderPlayers();}
      });
      c.send({type:"joined",host:true});
    });
  });
};
$("btnJoin").onclick=()=>{
  const code=$("roomInput").value.trim();
  myName=$("playerName").value||"Player";
  peer=new Peer(undefined,{secure:true,debug:2});
  peer.on("open",id=>{
    myId=id;
    conn=peer.connect(code.toLowerCase());
    conn.on("open",()=>{conn.send({type:"join",id:myId,name:myName});});
    conn.on("data",d=>{
      if(d.type=="start") startGame();
    });
  });
};
$("btnStart").onclick=()=>{
  $("lobbyPanel").style.display="none";
  $("canvasWrap").style.display="block";
  if(isHost && conn) conn.send({type:"start"});
  startGame();
};
function renderPlayers(){
  const p=$("playersList"); p.innerHTML="";
  for(const id in players){
    const d=document.createElement("div");
    d.textContent=players[id].name+(id==myId?" (You)":"");
    p.appendChild(d);
  }
}

// ======= GAME =========
function startGame(){
  $("lobbyPanel").style.display="none";
  $("canvasWrap").style.display="block";
  score=0; gameOver=false;
  pipes=[]; lastPipe=0;
  birds[myId]={x:150,y:250,vy:0,name:myName,score:0};
  canvas.onclick=()=>{ if(!gameOver) birds[myId].vy=flap; };
  requestAnimationFrame(loop);
}
function resetGame(){
  $("deathScreen").style.display="none";
  score=0; gameOver=false; birds[myId].y=250; birds[myId].vy=0; pipes=[];
  requestAnimationFrame(loop);
}
$("btnReset").onclick=resetGame;

function loop(ts){
  ctx.fillStyle="#70c5ce";
  ctx.fillRect(0,0,800,600);

  // pipes spawn
  if(ts-lastPipe>2000){
    let top=Math.random()*200+50;
    pipes.push({x:800,top:top,gap:150});
    lastPipe=ts;
  }

  // move pipes
  for(let i=pipes.length-1;i>=0;i--){
    const p=pipes[i];
    p.x-=2;
    ctx.fillStyle="#0a0";
    ctx.fillRect(p.x,0,50,p.top);
    ctx.fillRect(p.x,p.top+p.gap,50,600);
    if(p.x+50<0) pipes.splice(i,1);
    if(p.x+50==150) score++;
  }

  // bird
  const b=birds[myId];
  b.vy+=gravity;
  b.y+=b.vy;
  ctx.fillStyle="yellow";
  ctx.beginPath(); ctx.arc(b.x,b.y,15,0,Math.PI*2); ctx.fill();
  ctx.fillStyle="#000";
  ctx.font="14px Arial"; ctx.fillText(`${b.name} (${score})`,b.x-30,b.y-25);

  // collisions
  for(const p of pipes){
    if(b.x+15>p.x && b.x-15<p.x+50){
      if(b.y-15<p.top || b.y+15>p.top+p.gap){
        gameOver=true;
      }
    }
  }
  if(b.y>600 || b.y<0) gameOver=true;

  $("score").textContent=score;
  if(!gameOver) requestAnimationFrame(loop);
  else $("deathScreen").style.display="flex";
}
</script>
</body>
</html>
